\section{Formalization}
\label{sec:formalization}

~\JS{What is the difference between our formalization and the related work? (added by Runchao)}
In this section, we formalize the American Call Option and the Atomic Swap protocol,
then prove that the Atomic Swap is equivalent to an American Call Option without the premium.

\subsection{American Call Option}

The American Call Option is a contract that ``one can buy an amount of an asset with an agreed price prior to or on an agreed time in the future''. 
The agreed price is usually called the \textit{spot price}, and the buying is called \textit{exercising}.
For American Call Option, the option buyer can exercise in advanced of the agreed exercise time.
The price of the asset when exercising is called the \textit{strike price}.
As mentioned in Section~\ref{subsec:background_option}, the option contract itself has value, and its value is called the \textit{premium}.
The option buyer should pay for both the asset and the premium when participating in the contract.

Note that the price of the asset changes over time. This makes the American Call Option ``speculative'': One may profit from the contract by buying the asset with a lower price then sell it with a higher price.

\begin{definition}
We define an American Call Option contract $\Pi$ as

$$\Pi = (\pi_1, \pi_2, K, A, T, C)$$

where
$\pi_1$ and $\pi_2$ are the currency of the option buyer and the asset of the option seller, respectively; 
$K$ is the strike price with the unit $\pi_2 / \pi_1$ \HY{isnt it  $\pi_1 / \pi_2$?}- the price of $\pi_2$ measured in $\pi_1$;
$A$ is the amount of the asset $\pi_2$ that the option seller wants to sell;
$T$ is the agreed strike time;
$C$ is the \textit{premium} with the unit $\pi_1$.
\end{definition}

The process of an American Call Option is as follows:

\begin{enumerate}
    \item \textbf{Advertise}: The option seller creates and advertises an American Call Option contract $\Pi = (\pi_1, \pi_2, K, A, T, C)$.
    \item \textbf{Contract}: The option buyer finds $\Pi$ is profitable, so he participates in $\Pi$.
    To participate, the option buyer should pay $C$ to the option seller first.
    Note that the option buyer does not pay for $A$ $\pi_2$ at this stage.
    Also note that the option seller cannot abort $\Pi$ after the option buyer participates in $\Pi$.
    \item \textbf{Hold}: The option buyer keeps not exercising $\Pi$. If he doesn't exercise $\Pi$ before $T$, $\Pi$ will abort.
    \item \textbf{Exercise}: The option buyer exercises $\Pi$ - The option buyer pays $AK$ $\pi_1$ to the option seller, and the option seller gives $y$ \HY{define $y$?} $\pi_2$ to the option buyer. The option buyer can exercise $\Pi$ before or on $T$.
\end{enumerate}

% asset underlying value
The underlying value of $\pi_2$ is fluctuating over time due to the market mechanism.
Intuitively, if the price of $\pi_2$ rises when the option buyer exercises $\Pi$, the option buyer profits, because he buys $\pi_2$ with the price lower than the current market price.
Formally, we denote the asset's underlying value (with the unit $\pi_2 / \pi_1$) at the time $t$ as $S_t$.
Assume the option buyer exercises $\Pi$ at a time $T' \leq T$, he can profit $[(S_{T'} - K) A - C]$ $\pi_1$.
\JS{Say that the buyer can stop, and lose at most C. (added by Runchao)} 
Note that the value can be negative\MOD{, which is at most $C$. This implies that the buyer may encounter a loss at the most value of $C$. However, the buyer can also choose to abort the contract to mitigate his loss, if he finds the price is not profitable}.










\subsection{Atomic Swap}

\JS{Which atomic swap you are formalizing? (added by Runchao)}
\begin{definition}
We define an Atomic Swap $\mathcal{AS}$ as

$$\mathcal{AS} = (x_1, Coin_1, x_2, Coin_2)$$

where Alice hopes to buy $x_2$ $Coin_2$ on blockchain $BC_2$ from Bob with $x_1$ $Coin_1$ on blockchain $BC_1$.
\end{definition}

The Atomic Swap protocol consists of five algorithms:
\textbf{Setup},
\textbf{Initiate},
\textbf{Participate},
\textbf{Redeem}, and
\textbf{Refund}.

% \TODO{add input and output of each algorithm}
% \begin{enumerate}
%     \item \textbf{Setup}: Alice and Bob create addresses on both blockchains.
%     \item \textbf{Initiate}: Alice initiates the Atomic Swap by publishing a contract transaction on $BC_1$.
%     \item \textbf{Participate}: Bob participates in the Atomic Swap by publishing a contract transaction on $BC_2$.
%     \item \textbf{Redeem}: Alice redeems $x_2$ $Coin_2$ and Bob redeems $x_1$ $Coin_1$. Alice should redeem earlier than Bob.
%     \item \textbf{Refund}: If Alice or Bob is unsatisfied with the Atomic Swap, he/she can get his/her money back after the timelock of the contract transaction.
% \end{enumerate}

\paragraph{\textbf{Setup}}
takes the security parameter $k$,
and returns the addresses on two blockchains for Alice and Bob $\beta_{A, 1}$, $\beta_{A, 2}$, $\beta_{B, 1}$, $\beta_{B, 2}$.

\paragraph{\textbf{Initiate}}
takes $\beta_{B, 1}$ and $x_1$,
and returns the preimage $s$, the preimage hash $h$, the contract script $\mathcal{C}_1$, the contract transaction $tx_{\mathcal{C}, 1}$, the refund script $\mathcal{R}_1$, and the refund transaction $tx_{\mathcal{R}, 1}$.
The preimage $s$ is a random string generated by Alice. At this stage, $s$ is only known to Alice.
The preimage hash $h = H(s)$, where $H$ is a secure hash function.  $h$ is published when \textbf{initiate}.
The contract script $\mathcal{C}_1$ is that ``Alice pays $x_1$ $Coin_1$ from $\beta_{A, 1}$ to $\beta_{B, 1}$ if Bob can provide $s$ before or on a timelock $\delta_1$ (which is a timestamp). After $\delta_1$, Alice can refund the money - get $x_1$ $Coin_1$ back.''
The contract script is published as a transaction $tx_{\mathcal{C}, 1}$ on $BC_1$ when \textbf{initiate}.
The refund script $\mathcal{R}_1$ is that ``Alice pays $x_1$ $Coin_1$ from $\beta_{A, 1}$ to her another address.'' This is to ensure $x_1$ $Coin_1$ can no longer be redeemed by others. Alice can do this only after $\delta_1$.
The refund is done by publishing $\mathcal{R}_1$ as a transaction $tx_{\mathcal{R}, 1}$ on $BC_1$ if Alice can and decide to refund.

\paragraph{\textbf{Participate}}
takes $\beta_{A, 2}$, $x_2$ and $h$,
and returns the contract script $\mathcal{C}_2$, the contract transaction $tx_{\mathcal{C}, 2}$, the refund script $\mathcal{R}_2$, and the refund transaction $tx_{\mathcal{R}, 2}$.
The contract script $\mathcal{C}_2$ is that ``Bob pays $x_2$ $Coin_2$ from $\beta_{B, 2}$ to $\beta_{A, 2}$ if Alice can provide $s$ before or on a timelock $\delta_2$ (which is a timestamp). After the time of $\delta_2$, Bob can refund the money - get $x_2$ $Coin_2$ back.''
Here $\delta_2$ should expire earlier than $\delta_1$.
The contract script is published as a transaction $tx_{\mathcal{C}, 2}$ on $BC_2$ when \textbf{initiate}.
The refund script $\mathcal{R}_2$ is that ``Bob pays $x_2$ $Coin_2$ from $\beta_{B, 2}$ to his another address.'' This is to ensure $x_2$ $Coin_2$ can no longer be redeemed by others. Bob can do this only after $\delta_2$.
The refund is done by publishing $\mathcal{R}_2$ as a transaction $tx_{\mathcal{R}, 2}$ on $BC_2$ if Bob can and decide to refund.

\JS{I can see that you are trying to be formal, but this is not formal. Letâ€™s have a meeting on this, and I can walk this through with you. (added by Runchao)}

\paragraph{\textbf{Redeem}}
takes $s$,
and returns $\mathcal{V} \in \{true, false\}$ indicating if the redemption is successful or not.
The redemption can be performed by both parties, and Alice should redeem earlier than Bob.
As Alice knows $s$, she can redeem $x_2$ $Coin_2$ - pay $x_2$ $Coin_2$ in $\beta{A, 2}$ to her another address by attaching $s$ in this transaction.
After Alice redeems $x_2$ $Coin_2$, $s$ is published and revealed to everyone including Bob, so that Bob can redeem $x_1$ $Coin_1$, similarly.

\paragraph{\textbf{Refund}}
takes no parameters and returns the $\mathcal{V} \in \{true, false\}$ indicating if the refund is successful or not.
Alice and Bob can perform the refund by publishing $tx_{\mathcal{R}, 1}$ and $tx_{\mathcal{R}, 2}$ after the timelock $\delta_1$ and $\delta_2$, respectively.

% procedure
\paragraph{Process.}
Alice and Bob proceeds the Atomic Swap as follows:
Alice and Bob first creates addresses by \textbf{Setup}.
Alice then \textbf{initiate}s the swap, and Bob \textbf{participate}s in the swap.
Within $\delta_2$ Alice can \textbf{redeem} $Coin_2$, then Bob can \textbf{redeem} $Coin_1$.
In this case, the swap succeeds for both Alice and Bob.
However, Alice can also keep not \textbf{redeem}ing $Coin_2$ and wait for $\delta_2$ to expire.
After $\delta_2$ expires, Bob can \textbf{refund} $Coin_2$, and Alice can \textbf{refund} $Coin_1$ after $\delta_1$ expires.
In this case, the swap fails for both Alice and Bob.

% why atomic
We can see that the swap either succeeds or fails for both Alice and Bob.
In detail,

\begin{itemize}
    \item If Alice misbehaves when \textbf{setup} or \textbf{initiate}, Bob will lose nothing as he hasn't deposited $Coin_2$ yet.
    \item If Bob misbehaves when \textbf{participate}, Alice can choose to abort the swap by \textbf{refund}ing.
    \item Alice can only choose to \textbf{redeem} $Coin_2$ or wait $\delta_2$ to expire.
    Once Alice \textbf{redeem}s, Bob can also \textbf{redeem}s $Coin_1$.
    Once $\delta_2$ expires, Bob can \textbf{refund} $Coin_2$ back.
\end{itemize}

% misuse
However, one may take both $Coin_1$ and $Coin_2$ if the other does not \textbf{redeem} or \textbf{refund} on time.
For example, if Bob does not \textbf{redeem} $Coin_1$ after Alice \textbf{redeem} $Coin_2$ and $\delta_1$ expires, Alice can also \textbf{refund} $Coin_1$.
But in this case it is Bob to blame, because he should have had enough time - at least $\delta_2 - \delta_1$ \MOD{(24 hours by default)} - to \textbf{redeem} $Coin_1$.
Another example is that Alice broadcasts the transaction of \textbf{redeem}ing $Coin_2$ after $\delta_2$, but Bob has already \textbf{refund} $Coin_2$.
Therefore, Bob can also \textbf{redeem} $Coin_1$ by finding the preimage in Alice's \textbf{redeem} transaction before $\delta_1$.
Similarly, it is Alice to blame, because she should have had enough time - before $\delta_2$ - to \textbf{redeem} $Coin_2$.

% def S_t
Similar to conventional finance assets, $Coin_2$'s value is also fluctuating due to the market mechanism.
We denote the asset's underlying value (with the unit $Coin_2 / Coin_1$) at the time $t$ as $S_t$.















\subsection{Modelling the Atomic Swap as the American Call Option}

We model the Atomic Swap protocol as the American Call Option.
In detail, the Atomic Swap protocol is equivalent to a premium-free American Call Option.

Assume Alice \textbf{initiate}s an Atomic Swap $\mathcal{AS} = (x_1, Coin_1, x_2, Coin_2)$ and Bob \textbf{participate}s $\mathcal{AS}$.

\begin{theorem}
$\mathcal{AS} = (x_1, Coin_1, x_2, Coin_2)$ is equivalent to the American Call Option contract

$$
\Pi = (Coin_1, Coin_2, \frac{x_2}{x_1}, x_2, \delta_2, 0)
$$

\end{theorem}


\begin{proof}
% model the atomic swap as aco
In the American Call Option context, the option buyer Alice wants to buy $x_2$ $Coin_2$ from the participant Bob by using $x_1$ $Coin_1$.
$Coin_1$ is the currency Alice uses, $Coin_2$ is the asset Bob has.
$\frac{x_2}{x_1}$ is the price of the asset from Alice's perspective, so $\frac{x_2}{x_1}$.
$\delta_2$ is the timelock of the contract transaction on $BC_2$.
It is equivalent to the strike time of $\Pi$, because after $\delta_2$ Bob can refund his asset back and invalidate $\mathcal{AS}$, but before $\delta_2$ Bob cannot abort $\mathcal{AS}$ if Alice \textbf{participate}s.
Establishing the Atomic Swap does not require Alice to pay anything other than the asset to Bob, so the premium here is zero.
\end{proof}












