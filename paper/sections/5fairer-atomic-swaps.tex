\section{Fair Atomic Swaps}
\label{sec:fair_atomic_swap}

In this section, we propose two fair variants of the original Atomic Swap protocol, of which one is for currency exchange and the other is for American Call Options.

\TODO{pseudocode?}


\subsection{Design}

\subsubsection{Difference between Currency Exchange and Options}
\label{subsubsec:diff_spot_option}

Before designing a fair Atomic Swap protocol, we should know its design objective:
Is the protocol aiming at currency exchange or the American Call Options?

To our knowledge, the Atomic Swap protocol is originally designed for the fair exchange between different cryptocurrencies.
\MOD{However, according to our analysis, the protocol is unfair because Alice can choose to proceed or abort the swap based on the asset price, and \sout{aborting the swap has no punishment} he will not receive any penalty if he abort the swap.}

The currency exchange and the American Call Option differ in Finance: The currency exchange is a type of Spots~\cite{hull1991introduction}, while the American Call Option is a type of Options.
The Spot Contract and the Option Contract aim at different application scenarios: The Spot Contract aims at exchanging the ownership of assets, while the Option Contract aims at providing the option buyer an ``option'' to trade.
More specifically, Spots and Options differ in the following aspects:

\begin{itemize}
    \item The Spot Contract is exercised immediately, while the Option Contract is exercised on or prior to a specified date in the future.
    \item The Spot Contract cannot be aborted once signed by both parties, while in the Option Contract the option buyer can abort the contract with the loss of the premium.
    \item The Spot Contract itself has no value, while the Option Contract itself has value - the premium.
\end{itemize}

\subsubsection{Atomic Swaps for Currency Exchange and American Call Options}
\label{subsubsec:design_obj}

According to Section~\ref{subsubsec:diff_spot_option}, the currency exchange-style Atomic Swaps and the American Call Option-style Atomic Swaps differ in design objectives.

\paragraph{Atomic Swaps for Currency Exchange}
For the currency exchange, both parties should not abort the contract once signed.
However, in Atomic Swaps, Alice can abort the swap by not releasing the hash preimage.
Therefore, we should discourage Alice to abort the swap.
To achieve this, we can use the premium mechanism as the collateral: Alice should deposit the premium besides her asset when \textbf{initiate}.
The premium should follow that:

\begin{itemize}
    \item If the swap is settled or Bob aborts the swap, the premium will go back to Alice.
    \item If Alice aborts the swap, the premium will go to Bob.
\end{itemize}

\paragraph{Atomic Swaps for American Call Options}
For the American Call Options, the option buyer should pay for the premium besides the bought asset, regardless whether the contract is settled or aborted.
In reality, the option sellers are trustworthy - They never abort the contract.
However, in Atomic Swaps, Bob can abort the contracts like Alice.
To keep the Atomic Swap consistent with the American Call Options,
the premium in American Call Option-style Atomic Swaps should follow that: 

\begin{itemize}
    \item If the swap is settled or Alice aborts the swap, the premium will go to Bob.
    \item If Bob aborts the swap, the premium will go back to Alice.
\end{itemize}












\subsection{Our protocols}
We propose two fair Atomic Swap protocols based on the original Atomic Swap protocol and our design objectives in Section~\ref{subsubsec:design_obj}.
One of the two protocols is for currency exchange, and the other is for American Call Options.

Formally, define an Atomic Swap protocol $\mathcal{AS}'$ as

$$\mathcal{AS}' = (x_1, Coin_1, x_2, Coin_2, pr)$$

where $pr$ is the amount of the premium measured in $Coin_2$.
In our protocols, Alice should lock $pr$ on $BC_2$, which will be described later.

The protocol follows the steps below:
\JS{We should have a MSC/sudo-code algorithm for all protocols mentioned in this paper, and make them easy to compare. For example, one notable difference is that traditionally, buyer pays premium, but here, the seller pays. If using MSC, then we should highlight the parts of protocol that is not fair. If using sudo-code, then we need to explain each line in our text, and mention which lines make it (un)fair. So this could present a very clear view on the changes we made (added by Runchao)}
\begin{enumerate}
    \item \textbf{Setup}: Alice and Bob create addresses on both blockchains.
    In addition, Alice creates both contracts $\mathcal{C}_1$ and $\mathcal{C}_2$ and publishes them as transactions $tx_{\mathcal{C}, 1}$ and $tx_{\mathcal{C}, 2}$ on $BC_1$ and $BC_2$. 
    \item \textbf{Initiate}: Alice locks her $x_1$ $Coin_1$ on $BC_1$, and lock her $pr$ on $BC_2$, both with the timelock $\delta_1$.
    \item \textbf{Participate}: Bob locks his $x_2$ $Coin_2$ on $BC_2$ with the timelock $\delta_2 < \delta_1$.
    \item \textbf{Redeem}: Alice redeems $x_2$ $Coin_2$ first, then Bob redeems $x_1$ $Coin_1$.
    \item \textbf{Refund}: If Alice does not redeem $x_2$ $Coin_2$ before $\delta_2$ expires, Bob can refund $x_2$ $Coin_2$ and redeem $pr$.
    If Bob does not redeem $x_1$ $Coin_1$ before $\delta_1$ expires, Alice can refund $x_1$ $Coin_1$ and $pr$.
\end{enumerate}

\paragraph{\textbf{Setup}}
In addition to the address generation in the original protocol,
Alice creates and publishes both contracts on $BC_1$ and $BC_2$.
In the original protocol, Alice and Bob create $\mathcal{C}_1$ and $\mathcal{C}_2$, and publish $tx_{\mathcal{C}, 1}$ and $tx_{\mathcal{C}, 2}$ on $BC_1$ and $BC_2$, respectively.
In our protocol, Alice is responsible for creating and publishing both of them.

$\mathcal{C}_1$ remains the same as the original protocol, while $\mathcal{C}_2$ is more sophisticated here - It contains two coherent sub-contracts as follows:

\begin{itemize}
    \item $\mathcal{C}^{asset}_2$: The contract for the asset $x_2$ $Coin_2$
    \item $\mathcal{C}^{pr}_2$: The contract for the premium $pr$
\end{itemize}

$\mathcal{C}^{asset}_2$ is the same as in the original protocol $\mathcal{AS}$.
$\mathcal{C}^{pr}_2$ differs for the currency exchange and the American Call Options.

The content of $\mathcal{C}^{pr}_2$ for currency exchange-style $\mathcal{AS}'$ and American Call Option-style $\mathcal{AS}'$ are shown below:

\begin{description}
    \item[Currency Exchange] Alice pays $pr$ to Bob with the condition:
    Bob refunds $x_2$ $Coin_2$ after $\delta_2$ and before $\delta_1$.
    If $\delta_1$ expires, Alice can refund $pr$ back.
    \item[American Call Options] Alice pays $pr$ to Bob with one of the two conditions:
    1) Alice redeems $x_2$ $Coin_2$ before $\delta_2$.
    2) Bob refunds $x_2$ $Coin_2$ after $\delta_2$ but before $Delta_1$ (note that $\delta_2 < \delta_1$).
    If $\delta_1$ expires, Alice can refund $pr$ back.
\end{description}

Note that $\delta_1$ in $\mathcal{C}_1$ is the same as in $\mathcal{C}^{pr}_2$, and $\mathcal{C}^{asset}_2$ is with $\delta_2$.

Also note that neither of them triggers contracts at this stage.
Instead, Alice and Bob can enter the contracts in the future.
In this stage, Bob can decide whether to participate in $\mathcal{AS}'$ by auditing $tx_{\mathcal{C}, 1}$ and $tx_{\mathcal{C}, 2}$: If both contracts are fair, Bob will participate, otherwise Bob will not participate in this contract and find contracts from others.

\paragraph{\textbf{Initiate}}
Alice initiates the swap by entering $\mathcal{C}_1$ and $\mathcal{C}^{pr}_2$.
First, Alice deposits her $x_1$ $Coin_1$ in $\mathcal{C}_1$, and triggers the hash-locked payment to Bob.
Second, Alice deposits her $pr$ in $\mathcal{C}^{pr}_2$, and triggers the conditional payment to Bob.
Note that Alice can specify an arbitrary amount for $pr$ when creating $\mathcal{C}_2$, and Alice should have enough $Coin_2$ to deposit $pr$.
\MOD{Also not that if Bob keeps not participating, Alice's $x_1$ $Coin_1$ and $pr$ will be locked in $\mathcal{C}_1$ and $\mathcal{C}^{pr}_2$, and Alice can only refund them after the $\delta_1$.}

\paragraph{\textbf{Participate}}
If Bob thinks $\mathcal{AS}'$ is fair for him, he will participate in $\mathcal{AS}'$ by depositing $x_2$ $Coin_2$ in $\mathcal{C}^{asset}_2$, and triggers the the hash-locked payment to Alice.

\paragraph{\textbf{Redeem}}
Same as the original protocol, Alice redeems $x_2$ $Coin_2$ in $\mathcal{C}^{asset}_2$ by releasing $s$, then Bob can redeem  $x_1$ $Coin_1$ in $\mathcal{C}_1$ using the released $s$.
Note that once Bob redeems $x_1$ $Coin_1$, he cannot redeem $pr$ anymore according to $\mathcal{C}^{pr}_2$.

\paragraph{\textbf{Refund}}
Refunding $x_2$ $Coin_2$ for Alice and $x_1$ $Coin_1$ for Bob are the same as in the original protocol.
Alice can refund $pr$ after $\delta_1$ if Bob has not refunded $x_1$ $Coin_1$.
If Bob refunds $x_1$ $Coin_1$ before $\delta_2$ (which is definitely before $\delta_1$ as $\delta_2 < \delta_1$), Bob can also redeem $pr$.

\TODO{justify the fairness?}