\section{A Fair Atomic Cross-Chain Swap}
\label{sec:fair_atomic_swap}

\subsection{Design}

\subsubsection{Difference between Currency Exchange and Options}

Before designing a fair Atomic Cross-Chain Swap protocol, we should know the design objective:
Is the protocol aiming at currency exchange or the American Call Options?

To our knowledge, the Atomic Cross-Chain Swap protocol is originally designed for the fair exchange between different cryptocurrencies.
However, according to our analysis, the protocol is equivalent to the premium-free American Call Options, and is unfair due to the free premium.

The currency exchange and the American Call Option differ in finance: the currency exchange is a type of Spots, while the American Call Option is a type of Options.
The Spot Contract and the Option Contract aim at different application scenarios: The Spot Contract aims at exchanging the ownership of assets, while the Option Contract aims at providing the option buyer an ``option'' to trade.

In detail, Spots and Options differ in the following aspects:

\begin{itemize}
    \item The Spot Contract is exercised immediately, while the Option Contract is exercised on a specified future date.
    \item The Spot Contract cannot be aborted once signed by both parties, while in the Option Contract the option buyer can abort the contract with the loss of the premium.
    \item The Spot Contract itself has no value, while the Option Contract itself has value - the premium.
\end{itemize}

\subsubsection{Atomic Swaps for Currency Exchange and American Call Options}

% design objecive: fairness
% 1. cannot get both assets
% 2. fair exchange of assets
%   (how to define fair? currency exchange: no premium
%    option: must pay premium
% 3. initiator cannot painlessly abort
% 4. participant can choose to or not to join, but cannot abort

% why premium should be on blockchain2

% timing constraint for each step

The Atomic Swaps for the currency exchange and the American Call Option should be different, because of their different design objectives.

\paragraph{Atomic Swaps for Currency Exchange}
For the currency exchange, both parties should not abort the contract once signed.
However, the Atomic Swaps are not guaranteed to succeed because HTLCs' timelock is limited by time.
Instead, we can use the premium mechanism to discourage the option buyer to abort the contract: The option buyer should deposit the premium when signing the contract, then

\begin{itemize}
    \item If the contract is settled correctly, the premium will go back to the option buyer.
    \item If the option buyer aborts the contract after signing, the premium will go to the option seller.
    \item If the option seller aborts the contract after signing, the premium will go to the option buyer.
\end{itemize}

\paragraph{Atomic Swaps for American Call Options}
For the American Call Options, the option buyer should pay for the premium besides the bought asset, regardless whether the contract is settled correctly or not.
For the conventional Options, the option sellers are trustworthy and never abort the contracts: Option sellers are usually operated and endorsed by the governments.
However, the option sellers in Atomic Swaps are not trustworthy, and they may abort the contracts like the option buyers.
Once the option seller aborts a contract, the option buyer should get the premium back.
Therefore, the premium in the American Call Options by Atomic Swaps should follow that: 

\begin{itemize}
    \item If the contract is settled correctly or the option buyer aborts the contract, the premium will go to the option seller.
    \item If the option seller aborts the contract, the premium will go back to the option buyer.
\end{itemize}


\subsection{Our Protocol Construction}

We define an Atomic Cross-Chain Swap protocol $\mathcal{AS}'$ as

$$\mathcal{AS}' = (x_1, Coin_1, x_2, Coin_2, pr)$$

where $pr$ is the premium amount that the initiator should lock on $BC_2$, measured in $Coin_2$.

The protocol follows the steps below:

\begin{enumerate}
    \item \textbf{Setup}: Alice and Bob create addresses on both blockchains.
    In addition, Alice creates both contracts $\mathcal{C}_1$ and $\mathcal{C}_2$ and publishes them as transactions $tx_{\mathcal{C}, 1}$ and $tx_{\mathcal{C}, 2}$ on $BC_1$ and $BC_2$. 
    \item \textbf{Initiate}: Alice locks her $x_1$ $Coin_1$ on $BC_1$, and lock her $pr$ on $BC_2$.
    \item \textbf{Participate}: Bob locks his $x_2$ $Coin_2$ on $BC_2$. Note that Bob's timelock expires earlier than Alice's.
    \item \textbf{Redeem}: Alice redeems $x_2$ $Coin_2$ and Bob redeems $x_1$ $Coin_1$. Alice should redeem earlier than Bob.
    \item \textbf{Refund}: If Alice does not redeem $x_2$ $Coin_2$ before Bob's timelock expires, Bob can refund $x_2$ $Coin_2$ and redeem $pr$.
    If Bob does not redeem $x_1$ $Coin_1$ before Alice's timelock expires, Alice can refund $x_1$ $Coin_1$ and $pr$.
\end{enumerate}

\paragraph{Setup}
In addition to the address generation in the original protocol,
Alice creates and publishes both contracts on $BC_1$ and $BC_2$.
In the original protocol, Alice and Bob create $\mathcal{C}_1$ and $\mathcal{C}_2$, and publish $tx_{\mathcal{C}, 1}$ and $tx_{\mathcal{C}, 2}$ on $BC_1$ and $BC_2$, respectively.
In our protocol, Alice is responsible for creating and publishing both of them.

$\mathcal{C}_1$ remains the same as the original protocol, while $\mathcal{C}_2$ is more sophisticated here - It contains two coherent sub-contracts as follows:

\begin{itemize}
    \item $\mathcal{C}^{asset}_2$: The contract for the asset $x_2$ $Coin_2$
    \item $\mathcal{C}^{pr}_2$: The contract for the premium $pr$
\end{itemize}

$\mathcal{C}^{asset}_2$ is the same as in the original protocol.
$\mathcal{C}^{pr}_2$ differs for the currency exchange and the American Call Options.

For currency exchange, $\mathcal{C}^{pr}_2$ is that
``Alice pays $pr$ to Bob with the condition: If Bob refunds $x_2$ $Coin_2$ before the timelock $\Delta_1$ (which is definite as $x_2$ $Coin_2$ is timelocked by $\Delta_2 < \Delta_1$), Bob can redeem $pr$, otherwise Bob cannot.
If $\Delta_1$ expires, Alice can refund $pr$ back.''

For American Call Options, $\mathcal{C}^{pr}_2$ is that
``Alice pays $pr$ to Bob with the condition: If Alice redeems or Bob refunds $x_2$ $Coin_2$ before the timelock $\Delta_2$ (note that $\Delta_2 < \Delta_1$), Bob can redeem $pr$, otherwise Bob cannot.
If $\Delta_1$ expires, Alice can refund $pr$ back.''

% ``
% if $\Delta_1$ is expired:
%   initiator can refund $pr$
% else:
%   initiator cannot refund $pr$
%   if asset2 is refunded: // for currency exchange
%   if asset2 is redeemed: // for options
%     participant can redeem $pr$
%   else:
%     participant cannot redeem $pr$
% ''

Note that $\Delta_1$ in $\mathcal{C}_1$ is the same as in $\mathcal{C}^{pr}_2$, and $\mathcal{C}^{asset}_2$ is with the timelock $\Delta_2$.

Also note that neither of them triggers contracts at this stage.
Instead, Alice and Bob can enter the contracts in the future.
In this stage, Bob can decide whether to participate in $\mathcal{AS}'$ by auditing $tx_{\mathcal{C}, 1}$ and $tx_{\mathcal{C}, 2}$: If both contracts are fair, Bob will participate, otherwise Bob will not participate in this contract and find contracts from others.

\paragraph{Initiate}
Alice initiates the swap by entering $\mathcal{C}_1$ and $\mathcal{C}^{pr}_2$.
First, Alice deposits her $x_1$ $Coin_1$ in $\mathcal{C}_1$, and triggers the hash-locked payment to Bob.
Second, Alice deposits her $pr$ in $\mathcal{C}^{pr}_2$, and triggers the conditional payment to Bob.
Note that Alice can specify an arbitrary amount for $pr$ when creating $\mathcal{C}_2$, and Alice should have enough $Coin_2$ to deposit $pr$.

\paragraph{Participate}
If Bob thinks $\mathcal{AS}'$ is fair for him, he will participate in $\mathcal{AS}'$ by depositing $x_2$ $Coin_2$ in $\mathcal{C}^{asset}_2$, and triggers the the hash-locked payment to Alice.


\paragraph{Redeem}
Same as the original protocol, Alice redeems $x_2$ $Coin_2$ in $\mathcal{C}^{asset}_2$ by releasing $s$, then Bob can redeem  $x_1$ $Coin_1$ in $\mathcal{C}_1$ using the released $s$.
Note that once Bob redeems $x_1$ $Coin_1$, he cannot redeem $pr$ anymore according to $\mathcal{C}^{pr}_2$.

\paragraph{Refund}
Refunding $x_2$ $Coin_2$ for Alice and $x_1$ $Coin_1$ for Bob are the same as in the original protocol.
Alice can refund $pr$ after $\Delta_1$ if Bob has not refunded $x_1$ $Coin_1$.
If Bob refunds $x_1$ $Coin_1$ before $\Delta_2$ (which is definitely before $\Delta_1$ as $\Delta_2 < \Delta_1$), Bob can also redeem $pr$.

