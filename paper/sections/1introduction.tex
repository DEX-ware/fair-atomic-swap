\section{Introduction}
\label{sec:intro}

The Atomic Swap protocol allows two parties to exchange their assets ``atomically'' without trusted third parties.
``Atomic'' means the swap either succeeds or fails for both parties at any given time.
In blockchains, Atomic Swap is usually implemented by using Hashed Timelocked Contracts (HTLCs).
The HTLC is a type of transaction that, the payee should provide the preimage of a hash value before a specified deadline, otherwise the payment fails - the money goes back to the payer and the payee will not get any money.

% research problem
However, the Atomic Swap is atomic does not mean it is fair.
In particular, in an Atomic Swap, the swap initiator can decide whether to proceed the swap, and the default maximum time for him to decide is 24 hours~\cite{nolan2013alt}.
Whether this fact influences the fairness of the Atomic Swap remains unknown.

\MOD{
% optionality
We further observe that, this fact \sout{makes the Atomic Swap to have Optionality} (make sb do sth?) adds Optionality to the Atomic Swap.
In Finance, an investment is said to have Optionality if 1) settling this investment happens in the future rather than instantly; 2) settling this investment is optional rather than mandatory.
For an investment with Optionality, the option itself has value besides the underlying asset~\cite{higham2004introduction}, and the value is called the \textit{premium}.

% atomic swap should not have optionality
However, the Atomic Swap is designed for currency exchange rather than options, and the currency exchange should not have Optionality.
Once agreed by both parties, the currency exchange is settled without any chance for both parties to regret.
Moreover, the Atomic Swap does not have the premium mechanism.
Although the swap initiator decides whether to proceed or abort the swap, he does not need to pay for the option.

% what we do briefly
In this paper, we prove that the Atomic Swap is unfair to the participant, and propose two fair Atomic Swap variants.
We start from formally modeling the Atomic Swap and the American Call Option in Finance,
then prove that the Atomic Swap is equivalent to a premium-free American Call Option based on our model.
Following this proof, we then evaluate how unfair the Atomic Swap is from two different perspectives: quantifying the unfairness and estimating the premium.
After that, we propose two fair Atomic Swap protocols with the premium mechanism, in which one is for currency exchange while the other is for American Call Options.
Both protocols can be implemented on existing blockchains, and we give reference implementations as well.
Blockchains with smart contracts (e.g. Ethereum) directly support our protocols, and blockchains with scripts only (e.g. Bitcoin) can support out protocols by adding a simple opcode.
}



\subsection{Our contributions}

% In this paper, we prove that the Atomic Swap is unfair to the participant, and extends the original Atomic Swap protocol to fair ones.
% In particular, we formally model the Atomic Swap and the American Call Option in Finance,
% and prove that the Atomic Swap is equivalent to a premium-free American Call Option.
% Then we point out that the Atomic Swap is unfair to the participant, because the initiator is not required to pay for the premium.
% \MOD{Without premium, the initiator can abort the swap without any loss.
% In this way, the initiator can speculate without any risk - he can choose to proceed the swap when his asset price rises, and abort the swap when his asset price drops.}
% Based on this observation, we evaluate the unfairness of the Atomic Swap by estimating how much the premium should be for mainstream cryptocurrency pairs.
% Estimating the premium is based on the Cox-Ross-Rubinstein model~\cite{cox1979option} - the conventional model for pricing the American-style options in Finance.
% After that, we propose two fair Atomic Swap protocols, which implement the premium mechanism upon the original Atomic Swap protocol.
% One of our proposed protocols is for the currency exchange, and the other is for the American Call Options.
% Both protocols can be implemented on existing blockchains: \HY{Will it be better not to capitalize? (While it is acceptable to capitalize the first letter after the colon in American English, it is not the case in British English, except where a proper noun immediately follows a colon. \url{https://en.wikipedia.org/wiki/Colon_(punctuation)})}
% They can be directly implemented on blockchains supporting smart contracts (e.g. Ethereum),
% and can be implemented on blockchains supporting scripts (e.g. Bitcoin) by adding a single opcode.

Our contributions are as follows:

\paragraph{We formalize the Atomic Swap and the American Call Option, and prove that the Atomic Swap is equivalent to the premium-free American Call Option.}
We use formal languages to define the Atomic Swap and the American Call Option.
In particular, we describe them as protocols, and prove that the Atomic Swap is equivalent to the premium-free American Call Option:
The initiator and the participant in Atomic Swap are the option buyer and the option seller in American Call Options, respectively;
the initiator asset and the participant asset in Atomic Swap are the used currency and the underlying asset in American Call Options, respectively;
the participant asset's timelock in Atomic Swap is the strike time in American Call Options;
the current price of the participant asset in Atomic Swap is the strike price in American Call Options;
redeeming cryptocurrencies in Atomic Swap is exercising the contract in the American Call Options.

\paragraph{Based on our formalization, we prove that the Atomic Swap is unfair to the participant.}
We point out that, according to the option theory in Finance, the Atomic Swap - modelled as the premium-free American Call Option - is unfair to the participant, especially in the highly volatile cryptocurrency market.
In practice, the initiator can decide whether to proceed the swap while investigating the cryptocurrency market.
However, proceeding or aborting the swap does not require the initiator to pay for the premium.
This leads to the scenario that, if the initiator's asset price rises right before the strike time, he will proceed the swap to profit, otherwise he will abort the swap to avoid losing money.
In this way, the initiator is risk-free towards the market.

\paragraph{We evaluate the Atomic Swap unfairness of cryptocurrencies, and compare it with that of conventional finance assets.}
We evaluate the unfairness of the Atomic Swaps for mainstream cryptocurrency pairs, and also make comparisons between cryptocurrencies and conventional finance assets - stocks and fiat currencies.
Our evaluation and comparison consist of two parts: 1) quantifying the profit and the mitigated risk of the initiator, 2) estimating how much the premium should be.
% first
First, we quantify the profit and the mitigated risk of the initiator based on historical exchange rate volatility.
Our results show that with the default strike time of 24 hours, the profit and the mitigated risks of our selected cryptocurrency pairs are approximately 1\%, while for stocks and fiat currencies the values are approximately 0.3\% and 0.15\%, respectively.
% second
Second, we use the Cox-Ross-Rubinstein option pricing model to estimate how much the premium should be for Atomic Swaps in cryptocurrencies.
In Finance, the Cox-Ross-Rubinstein model is the conventional option pricing model for American-style options.
Our results show that, with the default strike time of 24 hours, for cryptocurrency pairs the premium should be approximately 2\%, while for stocks and fiat currencies the premium is negligible.
Also, the premium values rise for all items with the strike time increasing, then start to converge when the strike time reaches 300 days.

\paragraph{We propose two fair Atomic Swap protocols, one is for currency exchange and the other is for American Call Options.}
Based on our observation that the unfairness is introduced by the unpaid premium,
we then propose two fair Atomic Swap protocols, one is for currency exchange and the other is for American Call Options.
The two protocols achieve the fairness by implementing the premium mechanism upon the original protocol - The initiator should deposit the premium on the participant's blockchain when initiating the swap.
\MOD{
In the currency exchange-style protocol, the premium will go to the participant if the initiator misbehaves, otherwise it will go back to the initiator.
In the American Call Option-style protocol, the premium goes to the participant if the participant behaves well, otherwise it will go back to the initiator.
}

\paragraph{We describe how to implement our proposed protocols on existing blockchains.}
We give solutions to implement our protocols on existing blockchains, including blockchains supporting smart contracts and blockchains supporting scripts only.
For blockchains supporting smart contracts such as Ethereum, our protocols can be directly implemented.
For blockchains only supporting scripts such as Bitcoin, our protocols can be implemented by adding one more opcode.
We call the opcode ``OP\_LOOKUP\_OUTPUT'', and it looks up the owner of a specific output.
We use Solidity as an example of smart contracts, and the Bitcoin script code as an example of scripts.










\subsection{Paper structure}

The paper is structured as follows.
Section~\ref{sec:background} describes the background of Atomic Swap and options in Finance.
Section~\ref{sec:formalization} formalizes the Atomic Swap protocol and the American Call Option, then proves the Atomic Swap protocol is equivalent to the premium-free American Call Option.
Section~\ref{sec:evaluation} evaluates the Atomic Swap unfairness by analyzing the volatility and pricing the premium of mainstream cryptocurrency pairs.
Section~\ref{sec:fair_atomic_swap} describes our proposed fair Atomic Swap protocols.
Section~\ref{sec:implementation} describes how to implement our proposed protocols on existing blockchains.
Section~\ref{sec:discussion} discusses security issues of Atomic Swaps, other countermeasures for solving the Atomic Swap unfairness, and limitations of our protocols.
Section~\ref{sec:conclusion} concludes our paper and outlines the future work.