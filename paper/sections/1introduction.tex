\section{Introduction}
\label{sec:intro}

\HY{Indentions not so consistent.}\\
\HY{Space between paragraphs not so consistent.}

The Atomic Swap protocol is that two parties exchange \HY{(perform the exchange of?)} their assets ``atomically'' without trusted third parties \HY{(without any trusted thirdparty?)}.
``Atomic'' means the swap either succeeds or fails for both parties \HY{at any given time}.
Atomic Swap is implemented on blockchains by using the \HY{(remove "the"?)} Hashed Timelocked Contracts (HTLCs).
The HTLC is a type of transaction \HY{(contract?)} that, the payee should provide the preimage of a hash value before the deadline, otherwise the payment fails\HY{, and the payee will not receive the money}.

However, the fairness of the Atomic Swap is never studied formally.
First, there is no study that models the Atomic Swap in order to analyze whether both parties in the swap are equal.
Second, \HY{if having two parties reserving different rights, there is no research on the study of the risks they may encounter are equal, given that} the initiator in Atomic Swap can control the settlement time, while the asset price is fluctuating overtime.

In this paper, we prove that the Atomic Swap is unfair to the participant, and extends the original Atomic Swap \HY{protocol} to make it \HY{more} fair.
In particular, we formally model the Atomic Swap and the American Call Option in Finance,
and prove that the Atomic Swap is equivalent to a premium-free American Call Option.
Then we point out that the Atomic Swap is unfair to the participant, because the initiator is not required to pay for the premium \HY{, whereas it can speculate without any risk, making use of price fluctuations}.
Based on this observation, we evaluate the unfairness of the Atomic Swap by estimating how much the premium should be for mainstream cryptocurrency pairs.
Estimating the premium is based on the Cox-Ross-Rubinstein option pricing model in Finance, which is a conventional model to price the American-style options.
% TODO evaluation result
After that, we propose two fair Atomic Swap protocols, which implement the premium mechanism upon the original Atomic Swap protocols.
One of the protocols is for the currency exchange, and the other is for the American Call Options.
Both protocols can be deployed on existing blockchains:
They can be directly deployed on blockchains supporting smart contracts (e.g. Ethereum),
and can be deployed on blockchains supporting scripts (e.g. Bitcoin) by adding a single opcode.

Our contributions are as follows:

\paragraph{We formalize the Atomic Swap and the American Call Option, and prove that the Atomic Swap is equivalent to the premium-free American Call Option.}
We use formal languages to define the Atomic Swap and the American Call Option.
In particular, we describe them as protocols, and prove that the Atomic Swap is equivalent to the premium-free American Call Option:
The initiator and the participant in Atomic Swap are the option buyer and the option seller in American Call Options, respectively;
The initiator asset and the participant asset in Atomic Swap are the used currency and the underlying asset in American Call Options, respectively;
The participant asset's timelock in Atomic Swap is the strike time in American Call Options;
The current price of the participant asset in Atomic Swap is the strike price in American Call Options;
Redeeming cryptocurrencies in Atomic Swap is exercising the contract in the American Call Options.

\paragraph{We observe that the Atomic Swap is unfair to the particiapant due to the unpaid premium, and evaluate its unfairness by estimating the premium for mainstream cryptocurrency pairs.}
We point out that according to the option theory in Finance, the Atomic Swap - modelled as the premium-free American Call Option - is unfair to the participant, especially in the highly volatile cryptocurrency market.
In practice, the initiator can decide whether to swap based on the exchange rate trend: If his asset price falls, he will exercise the contract, otherwise he can wait for the contract to expire.
In this way, the initiator is risk-free towards the cryptocurrency market. 
We then evaluate the unfairness of the Atomic Swaps for mainstream cryptocurrency paris.
Our evaluation consists of two parts: the volatility analysis and the premium pricing.
First, we analyze the exchange rate volatility of mainstream cryptocurrency pairs, in order to reveal how much reward the initiator can get and how much risk the initiator can delegate to the participant.
Second, we estimate how much the premium should be, by using the Cox-Ross-Rubinstein option pricing model.
The Cox-Ross-Rubinstein model is the conventional option pricing model for American-style options.
By estimating the premium, we can reveal how unfair the Atomic Swap is.

\paragraph{We propose two fair Atomic Swap protocols, one is for currency exchange and the other is for American Call Options.}
Based on our observation that the unfairness is introduced by the unpaid premium,
we then propose two fair Atomic Swap protocols, one is for currency exchange and the other is for American Call Options.
The two protocols achieve the fairness by implementing the premium mechanism upon the original protocol - The initiator should deposit the premium on the participant's blockchain when initiating the swap.
In the currency exchange-style protocol, if the swap is successful, the premium goes back to the initiator, otherwise it goes to the participant.
In the American Call Option-style protocol, the premium goes to the participant once the participant's asset is redeemed or refunded.

\paragraph{We describe how to deploy our proposed protocols on existing blockchains.}
We give solutions to deploy our protocols on existing blockchains, including blockchains supporting smart contracts and blockchains supporting scripts only.
For blockchains supporting smart contracts such as Ethereum, our protocols can be directly deployed.
For blockchains only supporting scripts such as Bitcoin, our protocols can be deployed by adding one more opcode.
We call the opcode ``OP\_LOOKUP\_OUTPUT'', and it looks up the owner of a specific output.
We use Solidity as an example of smart contracts, and the Bitcoin script code as an example of scripts.

The paper is structured as follows.
Section~\ref{sec:background} describes the background of Atomic Swap and options in Finance.
Section~\ref{sec:formalization} formalizes the Atomic Swap protocol and the American Call Option, then proves the Atomic Swap protocol is equivalent to the premium-free American Call Option.
Section~\ref{sec:evaluation} evaluates the Atomic Swap unfairness by analyzing the volatility and pricing the premium of mainstream cryptocurrency pairs.
Section~\ref{sec:fair_atomic_swap} describes our proposed fair Atomic Swap protocols.
Section~\ref{sec:deployment} describes how to deploy our proposed protocols on existing blockchains.
Section~\ref{sec:discussion} discusses security issues of Atomic Swaps, other countermeasures for solving the Atomic Swap unfairness, and limitations of our protocols.
Section~\ref{sec:conclusion} concludes our paper and outlines the future work.