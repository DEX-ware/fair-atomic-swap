\section{Unfairness of Atomic Swaps}
\label{sec:evaluation}

Recall that the premium is the price paid by the option buyer for signing the option contract with the option seller.
In the Atomic Swap, the initiator is not required to pay for the premium.
In this way, the initiator can decide whether to proceed the swap while investigating the cryptocurrency market.
This enables the initiator to speculate without any risk:
if the initiator's asset price rises right before the strike time, he will proceed the swap to profit, otherwise he will abort the swap to avoid the loss.
Therefore, without the premium, the initiator is risk-free towards the market.

In this section, we evaluate the unfairness of the Atomic Swap based on our formalization in Section~\ref{sec:formalization}.
In particular, we evaluate the unfairness from two perspectives: quantifying the unfairness and estimating the unpaid premium.
Quantifying the unfairness is based on analyzing the historical exchange rate volatility, while estimating the unpaid premium is based on the Cox-Ross-Rubinstein option pricing model - the conventional option pricing model for American-style options.
Furthermore, we also evaluate conventional financial assets - the stocks and the currency exchanges - and compare their results with cryptocurrencies.

\subsection{Experimental setting}

We collected relevant data of mainstream cryptocurrencies for one year, starting from May 3th, 2018 to May 3th, 2019.
In particular, the cryptocurrency exchange rate data was retrieved from from CoinGecko~\footnote{\url{https://www.coingecko.com}. Data was fetched at May 4th, 2019.};
the stock index data was retrieved from Yahoo Finance~\footnote{\url{https://finance.yahoo.com}. Data was fetched at May 4th, 2019.};
the currency exchange rate data was retrieved from Investing.com~\footnote{\url{https://www.investing.com}. Data was fetched at May 4th, 2019.}.

All experiments run on a MacBook Pro with a 2.2 GHz Intel Core i7 Processor, a 16 GB DDR4 RAM and 256 SSD storage disk.

\subsection{Quantifying the unfairness by market volatility}
\label{subsec:volatility_analysis}

\begin{figure}
    \includegraphics[width=\linewidth]{unfair_diagram.eps}
    \caption{Visualizing the unfairness. The x-axis is time (in days), and the y-axis is the exchange rate change in percentage. For a point $(x, y)$, if $y > 0$, the point falls to the profit area (the red area on the figure), and the Atomic Swap initiator will profit $y$ today. If $y < 0$ the point falls to the risk area (the red area on the figure), and the Atomic Swap initiator will mitigate the loss of $y$ today.}
    \label{fig:unfair_diagram}
\end{figure}


\MOD{
\paragraph{Identifying the unfairness.}
We start from identify the unfairness of Atomic Swaps before quantifying it.

The unfairness consists of two parts, namely the profit when the initiator's asset price rises and the mitigated loss when the initiator's asset price drops.
Figure~\ref{fig:unfair_diagram} visualises the unfairness.
When the initiator's asset price rises, the initiator can profit directly from the rising price, and this scenario lays on the profit area in Figure~\ref{fig:unfair_diagram}.
When the initiator's asset price drops, the initiator can abort the swap and transfer the loss to the participant. This scenario lays on the risk area in Figure~\ref{fig:unfair_diagram}.
}

\paragraph{Quantifying the unfairness.}

\MOD{
Assume that the swap initiator \textbf{initiate}s the swap at the time $t$, then by default $\delta_1 = t + 48 (\text{hours})$.
We also assume that the swap participant \textbf{participate}s the swap right after \textbf{initiate}, then by default $\delta_2 = t + 24 (\text{hours})$.
In this way, the swap initiator can decide whether to proceed the swap within $ \delta_1 - \delta_2 = 24 (\text{hours})$.
}

\MOD{We test the unfairness by using a single Atomic Swap with the value of $x$ USD, then we show the degree of unfairness in dollars based on the historical data.}
For each day, the initiator may either profit $\alpha$ percent of $x$ directly if his asset price rises,
or mitigate $\beta$ percent of $x$ by aborting the swap if his asset price drops on average. \JS{The analysis here does not see correct. Letâ€™s talk and check.}
Assume the possibility for the initiator's asset price to rise is $P_{\alpha}$, and to drop is $P_{\beta}$.
Then, the expected profit rate is $E_{\alpha} = \alpha P_{\alpha}$,
and the expected mitigated risk rate is $E_{\beta} = \beta P_{\beta}$.
Therefore, the expected unfairness is that the initiator profits $E_{\alpha} x$ unconditionally and mitigates the risk of losing $E_{\beta} x$.
Also, as $E_\alpha$ and $E_\beta$ are equally calculated, they can be added together to derive the total unfairness as $E_\alpha + E_\beta$.

\paragraph{Experimental methodology.}
In our scenario, quantifying the unfairness is to estimate $E_{\alpha}$ and $E_{\beta}$.
We estimate $E_{\alpha}$ and $E_{\beta}$ for each selected cryptocurrency pair.
Furthermore,  we also evaluate the unfairness of stocks and fiat currencies in the same setting, in order to make comparisons.
We use S\&P500 and Dow Jones Index (DJI) as examples of stocks, and USD-EUR and USD-GBP as examples of fiat currencies.

\paragraph{Results and analysis.}

\begin{figure*}
    \includegraphics[width=\linewidth]{volatility_analysis.eps}
    \caption{The daily percentage changes for all selected cryptocurrency pairs, stock indices and fiat currency pairs over one year (from 03/05/2018 to 03/05/2019). For each figure, $E_{\alpha}$, $E_{\beta}$, $max_\alpha$ and $max_\beta$ are the expected profit rate, the expected mitigated risk rate, the maximum daily profit and the maximum daily mitigated risk, respectively.}
    \label{fig:volatility_analysis}
\end{figure*}

\begin{figure}
    \includegraphics[width=\linewidth]{vol_scatter.eps}
    \caption{Visualizing the expected profit rate $E_\alpha$ and the expected mitigated risk rate $E_\beta$ for each cryptocurrency pair, stock index and fiat currency pair.}
    \label{fig:vol_scatter}
\end{figure}

Figure~\ref{fig:volatility_analysis} shows the estimated $E_\alpha$, $E_\beta$, the maximum daily rises $max_\alpha$ and the maximum \TODO{use \url{https://marketplace.visualstudio.com/items?itemName=ban.spellright} or \url{https://marketplace.visualstudio.com/items?itemName=streetsidesoftware.code-spell-checker} to avoid introducing typos?} daily drops $max_\beta$ for chosen 8 cryptocurrency pairs, stock indices (S\&P500 and DJI) and fiat currency exchange rates (USD-EUR and USD-GBP).
Figure~\ref{fig:vol_scatter} visualizes $E_\alpha$ and $E_\beta$ of all evaluated items in Figure~\ref{fig:volatility_analysis}.

\TODO{analysis may be improved}
We observe that for all chosen cryptocurrency pairs, $max_\alpha$ and $max_\beta$ are quite big - ranging from 8\% to 25\%.
Meanwhile, $max_\alpha$ and $max_\beta$ of stock indices are much smaller than all cryptocurrency pairs,
and $max_\alpha$ and $max_\beta$ of fiat currencies are even smaller than stock indices.
This indicates that in the setting of an 24-hour Atomic Swap, the cryptocurrency is much more unfair than stocks, and the stocks are more unfair than fiat currencies.

Also, for all chosen cryptocurrency pairs, $E_{\alpha}$ and $E_{\beta}$ are near and the value is approximately 1\%, ranging from 0.73\% to 1.69\%.
For stock indices, the results of S\&P500 and DJI are the same - $E_\alpha = 0.33\%$ and $E_\beta = 0.29\%$, which are smaller than cryptocurrency pairs.
For fiat currencies, $E_\alpha$ and $E_\beta$ are even smaller than stock indices: The value ranges from 0.13\% to 0.17\%.
In addition to the unfairness results like the previous observation, we quantify the unfairness of Atomic Swaps for cryptocurrency pairs: It ranges from  1.65\% (BTC-XRP) to 2.97\% (BTC-BCH).



















\subsection{Estimating the premium}

\MOD{The unfairness of the Atomic Swap comes from the fact that the initiator can abort the contract without punishment.
In Finance, the premium mechanism guarantees the good behaviours, which also works for Atomic Swaps.
Therefore, we can evaluate the unfairness of the Atomic Swap by estimating the premium for American Call Options with cryptocurrencies.}

As the premium is the only variable in an option contract, estimating the premium is also called the ``Option Pricing'' problem.
In finance, the Black-Scholes (BS) Model is utilized to price the European Call Options,
while the Cox-Ross-Rubinstein (CRR) Model is utilized to price the American Call Options.

Therefore, in order to evaluate the unfairness of the Atomic Swap, we utilize the CRR Model to estimate the premium for American Call Options with cryptocurrencies.

\subsubsection{The Cox-Ross-Rubinstein Model Explained}

The Cox-Ross-Rubinstein (CRR) Model~\cite{cox1979option} - a.k.a. the Binomial Options Pricing Model (BOPM) - provides a generalizable numerical method for pricing the options.
Intuitively, the CRR model enumerates all possible prices of the asset in the near future based on the price volatility,
then reverse-engineers the premium based on the enumerated prices.
% binomial tree
The model assume that for each step on the binomial tree, the asset price rises or falls by a fixed rate.
Enumerating the possible asset prices constructs a binomial tree, where each node attaches an asset price and a premium price at a point of time.
% reverse engineering
By iteratively back propagating the premium from the leaves to the root of the binomial tree, the premium will be revealed.

Formally, using the CRR model to price the American Call Option $\Pi = (\pi_1, \pi_2, K, A, T, C)$ with the underlying price $S_t$ of $\pi_2$ follows the steps below:
\begin{enumerate}
    \item Creating the binomial price tree
    \item Calculating the premiums for leaf nodes
    \item Iteratively reconstructing the premiums for non-leaf nodes 
\end{enumerate}


\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{binomial-tree.eps}
    \caption{The binomial price tree $\mathcal{T}$. \JS{Maybe try to do it with tikz? This is a bit blurry atm. (added by Runchao)}}
    \label{fig:binomial_tree}
\end{figure}

\paragraph{Creating the binomial price tree.}
The binomial price tree $\mathcal{T}$ of the height $n$ represents the possible future prices within the time period $T$ discretely, as shown in Fig.~\ref{fig:binomial_tree}.
$n$ can be picked arbitrarily. With larger $n$, the result will be more accurate, but the computing overhead will be heavier.
Each node $\mathcal{T}_{t, i}$ is attached with the asset price $S_{t, i}$ and the premium $C_{t, i}$,
where $t \in \{0, \frac{T}{n}, \frac{2T}{n}, \dots, T\}$ is the point of time and $i$ is the number of the node at its level.
The CRR model assumes that the asset price will either move up or down by a specific factor per step in $\mathcal{T}$.
The move-up factor is $u$, and the move-down factor is $d$.
Accordingly, the price after one move-up is $S_{up} = u \cdot S$, and the price after one move-down is $S_{down} = d \cdot S$.
\JS{S is not defined. Is it possible to stay with the existing notation, i.e. $S_{t,i}$? (added by Runchao)}

$u$ and $d$ are calculated using the underlying annualized volatility $\sigma_a$ of the asset price:
\JS{Itâ€™s quite interesting, this seems to suggest that the drop and gain are symmetric, as $u\cdot d =1$. For example, if there is a high risk, then there will be high gain. (added by Runchao)}

\begin{align} 
u &= e^{\sigma_a \sqrt{\frac{T}{n}}}\\
d &= e^{- \sigma_a \sqrt{\frac{T}{n}}} = \frac{1}{u}
\end{align}

Here, $T$ is measured in years, and $\sigma_a$ is defined as the standard deviation of the annual price.
$\sigma_a$ can be computed from the daily price standard deviation $\sigma_d$ as below:

\begin{align} 
\sigma_a &= \sigma_d \sqrt{d}\\
\sigma_d &= \sqrt{\frac{\sum^{d}_{i=1} (S_i - \bar{S})^2}{d-1}}
\end{align}

where $d$ is the number of trading days within a year.
For cryptocurrencies, $d$ equals to the number of a days within a year.
Note that $S_i$ is the percentage change of the price on day $i$, rather than the price itself.
$\bar{S}$ is the average value of all $S_i$s within the $d$ days. 

The asset price $S_{t, i}$ can also be computed as $S_{t, i} = S_{0, 1} \cdot u^{N_u - N_d}$, where $S_{0, 1}$ is the spot price, and $N_u, N_d$ are the numbers of move-up and move-down, respectively.

\paragraph{Calculating the premiums for leaf nodes.}
In the first step, only the asset prices are determined rather than the premiums.
This step further determines the premiums for leaf nodes.
For each leaf node $\mathcal{T}_{n, i}$, the premium (for Call Options) is $C_{n, i} = max[(S_{n, i} - K), 0]$.

\paragraph{Iteratively reconstructing the premiums for earlier nodes.}
We back-propagate the premiums for leaf nodes to earlier premiums.
More specifically, the earlier premium is calculated from the premiums of the later two nodes weighted by their state transition possibilities.
The move-up and move-down possibility are $p$ and $q$ where $p + q = 1$, and the risk-free rate is $r = q$.

The earlier premium $C_{t - \Delta t, i}$ is calculated from later premiums as:

\begin{align}
C_{t - \Delta t, i} = e^{-r \Delta t} (p C_{t, i} + q C_{t, i+1})
\end{align}

where $\Delta t = \frac{T}{n}$, and $p, q, r$ are computed as

\begin{align} 
p &= \frac{e^{(r-q)\Delta t} - d}{u - d}\\
q &= 1 - p\\
r &= q
\end{align}

such that the premium distribution simulates the geometric Brownian motion with parameters $r$ and $\sigma$.

The earliest premium $S_{0, 1}$ - the estimated premium - can be calculated by iteratively back-propagating the later premiums. 

\JS{A table summarizing the notations will be nice â€” there are too many different notations, and I cannot remember them all. (added by Runchao)}

\subsubsection{Experiments}


\begin{figure}
    \includegraphics[width=\linewidth]{premium_pricing_result.eps}
    \caption{Estimated premium with different strike times for each cryptocurrency pair, stock index and fiat currency pair. Lines with the marker ``x'' are for stocks; lines with the marker ``o'' are for fiat currencies; and lines without marker are for cryptocurrency pairs.}
    \label{fig:premium_pricing_result}
\end{figure}

We price the same data as Section~\ref{subsec:volatility_analysis} by using the CRR model with $n = 36$ with the strike time $T$ ranging from $1$ to $300$.
Figure~\ref{fig:premium_pricing_result} shows our pricing results.

First, we observe that the premium of cryptocurrency pairs is much more expensive than stocks, and the premium of stocks is more expensive than fiat currencies at any given time.
Recall the evaluated unfairness in Section~\ref{subsec:volatility_analysis}, its results are consistent with the premium pricing results: The higher the volatility is, the more unfair the Atomic Swap will be, and the higher the premium should be.

Second, with the default strike time $T = 1$ of the Atomic Swap, the premium of cryptocurrency pairs vary from approximately 1\% to 2.3\% of the underlying asset value.

Third, for all evaluated items, the premium values rise monotonically.
This is because the longer expiration time lets the option buyer to have more control on the option - He has more time to predict the price and judges whether to exercise the option.